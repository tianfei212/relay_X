# JOJO-Relay-X 后端模拟测试程序开发说明

## 1. 项目概述
本程序是一个部署在北京内网的后端模拟器（BE-Simulator），用于测试杭州边缘节点的 JOJO-Relay-X 网关。其核心功能包括：
- 主动连接网关 5555 控制端口
- 模拟真实后端的注册、端口分配、密钥交换等行为
- 对 SRT 视频流进行回传（Echo）操作，验证网关的双向透明转发能力
- 模拟异常情况（如断连）以测试网关的熔断机制

## 2. 目录结构
程序代码应放置在项目根目录下的 `server_test/` 目录中：
```
server_test/
├── main.go                 # 程序入口
├── config/
│   └── loader.go          # 配置加载
├── client/
│   ├── control.go         # 5555 控制面客户端
│   └── data.go            # SRT/ZMQ 数据面客户端
└── utils/
    └── pool.go            # 内存池工具（复用网关的 sync.Pool）
```

## 3. 核心功能规范

### 3.1 5555 控制面交互逻辑
程序启动后需执行以下流程：

1. **主动注册**：连接网关 `:5555`，发送注册消息：
```json
{
  "type": "register",
  "payload": {
    "role": "BE",
    "secret": "dummy_secret"
  }
}
```

2. **端口分配**：向网关发送端口分配请求，模拟后端对 ZMQ/SRT 端口的需求：
```json
{
  "type": "port_alloc",
  "payload": {
    "zmq_start_port": 2302,
    "zmq_end_port": 2302,
    "srt_start_port": 2320,
    "srt_end_port": 2320
  }
}
```

3. **密钥交换**：向网关发送临时密钥，由网关透传给前端：
```json
{
  "type": "key_exchange",
  "payload": {
    "public_key": "dummy_key",
    "private_key": "temp_private_key_xyz"
  }
}
```

4. **时钟同步**：响应网关的 `ping` 请求，参与 RTT 测量：
```json
{
  "type": "ping",
  "payload": {
    "c_send": 1234567890123456789
  }
}
```
响应 `pong`：
```json
{
  "type": "pong",
  "payload": {
    "c_send": 1234567890123456789,
    "s_send": 1234567890123456790,
    "s_recv": 1234567890123456789
  }
}
```

### 3.2 SRT/ZMQ 数据面回传逻辑
1. **建立连接**：根据 5555 端口协商的端口信息，主动连接网关的 SRT/ZMQ 业务端口。
2. **数据回传**：从网关接收数据后，立即原样发送回网关，形成闭环。
3. **内存管理**：使用 `sync.Pool` 从内存池获取缓冲区，避免 GC 压力。

### 3.3 异常模拟功能
- **模拟断连**：提供指令使程序主动断开 5555 连接，测试网关熔断机制。
- **资源清理验证**：观察网关是否在 2 秒内正确释放相关端口资源。

## 4. 技术实现要求

### 4.1 代码规范
- **语言**：Go 1.26+
- **头部注释**：每个文件需包含版本、开发者、日期
- **中文注释**：所有导出函数需有详细中文说明

### 4.2 内存管理
- 使用 `sync.Pool` 管理缓冲区，参考网关 `v1/common/memory.go` 的实现
- 缓冲区大小建议为 32KB

### 4.3 配置管理
- 从配置文件加载网关地址、认证密钥等信息
- 配置文件路径：`server_test/config.yaml`

## 5. 开发任务分解

### Task 1: 基础框架搭建
- [ ] 创建 `server_test/` 目录结构
- [ ] 实现配置加载模块
- [ ] 实现基础的 5555 控制面连接与注册逻辑

### Task 2: 控制面协议实现
- [ ] 实现端口分配、密钥交换等功能
- [ ] 实现时钟同步（ping/pong）逻辑
- [ ] 实现遥测数据接收与显示

### Task 3: 数据面回传实现
- [ ] 实现 SRT 客户端连接逻辑
- [ ] 实现数据回传（Echo）功能
- [ ] 集成内存池管理

### Task 4: 异常模拟与测试
- [ ] 实现断连模拟功能
- [ ] 添加流量统计与显示
- [ ] 进行集成测试验证

## 6. 验证方法
1. 启动网关程序
2. 启动本模拟测试程序
3. 验证 5555 连接建立、端口分配、密钥交换等流程
4. 验证 SRT 数据回传功能
5. 测试断连后的熔断机制
